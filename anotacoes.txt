# Criar pasta wordpress_com_ansible
# Dentro da pasta wordpress_com_ansible criar o Vagrantfile

# Abrir o prompt e dentro da pasta wordpress_com_ansible executar o comando:
$ vagrant up

# Criar arquivo hosts e definir:
# [wordpress]
# 192.168.0.7

# Acessar VM wordpress via SSH
$ vagrant ssh

# Instalar ansible
$ sudo apt update
$ sudo apt upgrade
$ sudo apt install software-properties-common
$ sudo apt-add-repository ppa:ansible/ansible
# Enter
$ sudo apt update
$ sudo apt install ansible

# Checar versão
$ ansible --version

# Testando ansible
$ ansible wordpress -u vagrant --private-key .vagrant/machines/wordpress/virtualbox/private_key -i hosts -m shell -a 'echo Hello World!'

# Testando em modo verboso
$ ansible -vvvv wordpress -u vagrant --private-key .vagrant/machines/wordpress/virtualbox/private_key -i hosts -m shell -a 'echo Hello World!'

##################################################

# Criar Playbook
$ ansible-playbook provisioning.yml -u vagrant -i hosts --private-key .vagrant/machines/wordpress/virtualbox/private_key

# Acessar via ssh e visualizar o arquivo criado no diretório /vagrant
$ vagrant ssh
$ ls /vagrant

##################################################

# Adicionar a linha de configuração para a VM no arquivo playbook:
# Alterar playbook
---
- hosts: all
  tasks:
    - name: 'Instala o PHP5'
      apt: 
        name: php5
        state: latest
      become: yes
    - name: 'Instala o Apache2'
      apt:
        name: apache2
        state: latest
      become: yes
    - name: 'Instala o modphp'
      apt:
        name: libeapache2-mod-php5
        state: latest
      become: yes

# Instalar pacotes php5 e apache2 definido no playbook
$ ansible-playbook provisioning.yml -u vagrant -i hosts --private-key .vagrant/machines/wordpress/virtualbox/private_key

# Acessar o ip no navegador para testar o apache

##################################################

# Simplificando o script com with_itens
# Adicionar a linha de configuração para a VM no arquivo playbook:
# Alterar playbook
---
- hosts: all
  tasks:
    - name: 'Instala pacotes de dependência do sistema operacional'
      apt:
        name: "{{ item }}"
        state: latest
      become: yes
      with_itens:
        - php5
        - apache2
        - libeapache2-mod-php5
        - php5-gd
        - libssh2-php
        - php5-mcrypt
        - mysql-server-5.6
        - python-mysqldb
        - php5.mysql

##################################################

# Inserindo o nome do usuário e chave no arquivo de hosts
# 192.168.0.7 ansible_user=vagrant ansible_ssh_private_key_file="/Users/<seu usuario>/wordpress_com_ansible/..vagrant/machines/wordpress/vistualbox/private_key"

# Executando no terminal
$ $ ansible-playbook provisioning.yml -i hosts

##################################################

# Criando banco mysql no arquivo de hosts
# Adicionar a linha de configuração para a VM no arquivo playbook:
# Alterar playbook
- name: 'Cria o banco do MySQl'
      mysql_db: 
        name: wordpress_db
        login_user: root
      # login_password: (Aqui não será informada a senha pois nessa versão o padrão é criar login sem senha)
        state: present

# Executando no terminal
$ $ ansible-playbook provisioning.yml -i hosts

# Logando e testando
$ vagrant ssh
$ mysql -u root
$ show databases;
$ use wordpress_db;
$ show tables;
$ quit;

# Deletando banco mysql no arquivo de hosts
# Adicionar a linha de configuração para a VM no arquivo playbook:
# Alterar playbook
- name: 'Cria o banco do MySQl'
      mysql_db: 
        name: wordpress_db
        login_user: root
      # login_password: (Aqui não será informada a senha pois nessa versão o padrão é criar login sem senha)
        state: absent

# Executando no terminal
$ $ ansible-playbook provisioning.yml -i hosts

# Logando e testando
$ vagrant ssh
$ mysql -u root

##################################################

# Link da documentação do Ansible (v2.6) com a lista de todos os módulos de banco de dados:
# https://docs.ansible.com/ansible/2.6/modules/list_of_database_modules.html

# Link do módulo MySQL:
# https://docs.ansible.com/ansible/2.6/modules/mysql_db_module.html

##################################################

# Criando usuario mysql no arquivo de hosts
# Adicionar a linha de configuração para a VM no arquivo playbook:
# Alterar playbook
- name: 'Cria o usuário do MySQL'
      mysql_user: 
        login_user: root
        name: wordpress_user
        password: 12345
        priv: 'wordpress_db.*:ALL'
        state: present

# Executando no terminal
$ $ ansible-playbook provisioning.yml -i hosts

$ mysql -u root
$ show databases;
$ show tables;

# Testando usuário mysql
$ mysql -u wordpress_user -p
# inserir senha
$ show databases;

##################################################

# Configurando no arquivo de hosts o download  e descompactação do arquivo do wordpress
# Adicionar a linha de configuração para a VM no arquivo playbook:
# Alterar playbook
- name: 'Download do arquivo de instalação do Wordpress'
      get_url: 
        url: 'https://wordpress.org/latest.tar.gz'
        dest: '/tmp/wordpress.tar.gz'
        
    - name: 'Descompacta o arquivo'
      unarchive: 
        src: '/tmp/wordpress.tar.gz'
        dest: /var/www/
        remote_src: yes
      become: yes

# Executando no terminal
$ $ ansible-playbook provisioning.yml -i hosts